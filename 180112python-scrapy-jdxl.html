<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="25InLB4z-lcgUPp1i4Bq6PLaiiF9ntGvLioTu-1Yp3Y" />








  <meta name="baidu-site-verification" content="t1oNPvdeea" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-00.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-00.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-00.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo-00.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Python,Coding,编程,爬虫,Scrapy," />





  <link rel="alternate" href="/atom.xml" title="00's Adventure" type="application/atom+xml" />






<meta name="keywords" content="Python,Coding,编程,爬虫,Scrapy">
<meta property="og:type" content="article">
<meta property="og:title" content="码以致用02 - 用 Scrapy 爬虫抓取简单心理咨询师资料">
<meta property="og:url" content="http://uegeek.com/180112python-scrapy-jdxl.html">
<meta property="og:site_name" content="00&#39;s Adventure">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://img.viz.mobi/robot_rock_dribbble.jpg">
<meta property="og:image" content="http://img.viz.mobi/jdxlScrapy1.png">
<meta property="og:image" content="http://img.viz.mobi/jdxlScrapy2.png">
<meta property="og:image" content="http://img.viz.mobi/jdxlScrapy3.png">
<meta property="og:image" content="http://img.viz.mobi/jdxlScrapyOutput.png">
<meta property="og:image" content="http://img.viz.mobi/scrapy-jdxl-repo-qr.png">
<meta property="og:updated_time" content="2018-09-25T07:43:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="码以致用02 - 用 Scrapy 爬虫抓取简单心理咨询师资料">
<meta name="twitter:image" content="http://img.viz.mobi/robot_rock_dribbble.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://uegeek.com/180112python-scrapy-jdxl.html"/>





  <title>码以致用02 - 用 Scrapy 爬虫抓取简单心理咨询师资料 | 00's Adventure</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-12755583-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?816680a99713dbf6762e7f3a2e3f7a96";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">00's Adventure</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Why join the navy if you can be a pirate</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-资源">
          <a href="/resources/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            资源
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://uegeek.com/180112python-scrapy-jdxl.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="kidult00">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="00's Adventure">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">码以致用02 - 用 Scrapy 爬虫抓取简单心理咨询师资料</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-12T19:33:34+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/教程/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/180112python-scrapy-jdxl.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="180112python-scrapy-jdxl.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://img.viz.mobi/robot_rock_dribbble.jpg" alt=""></p>
<a id="more"></a> 
<h2 id="目标和步骤"><a href="#目标和步骤" class="headerlink" title="目标和步骤"></a>目标和步骤</h2><p>爬虫目标：从简单心理网站上抓取心理咨询师列表和信息。</p>
<p>学习目标：</p>
<ul>
<li>熟悉 Scrapy 框架，理解如何使用</li>
<li>初步掌握 xpath 语法</li>
<li>导出爬取信息为 csv</li>
<li>用 Pandas 查看和清理数据</li>
</ul>
<p><a href="http://jiandanxinli.com" target="_blank" rel="noopener">简单心理网站</a>上有「咨询咨询」和「精神科顾问」两类专家，这里先尝试抓取咨询师资料。</p>
<p>咨询师展示列表比较简单，一共有 49 页，每页有 10 或 11 个咨询师（真是有点坑……）。抓取每页上的信息即可。</p>
<p>步骤分解：</p>
<ul>
<li>抓取每一页上面所有咨询师的信息，包括姓名、简介、地点、咨询方式、地点、价格等</li>
<li>按页面顺序抓取全部咨询师资料</li>
<li>导出信息为 csv</li>
<li>用 pandas 查看信息</li>
</ul>
<h2 id="新建项目和爬虫"><a href="#新建项目和爬虫" class="headerlink" title="新建项目和爬虫"></a>新建项目和爬虫</h2><p><a href="http://www.uegeek.com/180108python-scrapy-introduction.html" target="_blank" rel="noopener">上一篇</a>已经介绍过 Scrapy 爬虫框架和如何新建 Python 虚拟环境。现在来新建一个 Scrapy 爬虫项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject jdxl</span><br></pre></td></tr></table></figure>
<p>Scrapy 生成了以下文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">├── jdxl</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── items.py</span><br><span class="line">│   ├── middlewares.py</span><br><span class="line">│   ├── pipelines.py</span><br><span class="line">│   ├── settings.py</span><br><span class="line">│   └── spiders</span><br><span class="line">│       └── __init__.py</span><br><span class="line">└── scrapy.cfg</span><br></pre></td></tr></table></figure>
<p>我们在 <code>spiders</code> 文件夹里新建爬虫文件 <code>counselor.py</code>。</p>
<p>然后在 <code>items.py</code> 里面定义要抓取的项目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JdxlItem</span><span class="params">(scrapy.Item)</span>:</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line">    name = scrapy.Field() <span class="comment">#姓名</span></span><br><span class="line">    url = scrapy.Field() <span class="comment">#链接</span></span><br><span class="line">    info = scrapy.Field() <span class="comment">#简介</span></span><br><span class="line">    zx_type = scrapy.Field() <span class="comment">#咨询类型</span></span><br><span class="line">    location = scrapy.Field() <span class="comment">#地点</span></span><br><span class="line">    price = scrapy.Field() <span class="comment">#价格</span></span><br></pre></td></tr></table></figure>
<h2 id="抓取页面信息"><a href="#抓取页面信息" class="headerlink" title="抓取页面信息"></a>抓取页面信息</h2><p>打开爬虫 <code>counselor.py</code>，开始写爬取的程序。</p>
<p>不要忘记先 import 上面定义好对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jdxl.items <span class="keyword">import</span> JdxlItem</span><br></pre></td></tr></table></figure>
<h3 id="问题1：如何设置起始-URL？"><a href="#问题1：如何设置起始-URL？" class="headerlink" title="问题1：如何设置起始 URL？"></a>问题1：如何设置起始 URL？</h3><p>打开<a href="https://www.jiandanxinli.com/experts" target="_blank" rel="noopener">心理咨询师列表页面</a>，然后翻到第二页，发现 url 是很长的一串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jiandanxinli.com/experts?filter%5Bcity_id%5D=&amp;filter%5Bfield_id%5D=&amp;filter%5Bgender%5D=&amp;filter%5Bonly_available%5D=&amp;filter%5Bonly_junior%5D=&amp;filter%5Bonly_online%5D=&amp;filter%5Bprice%5D=&amp;filter%5Bq%5D=&amp;filter%5Bsect_id%5D=&amp;filter%5Btarget_id%5D=&amp;filter%5Btime%5D=&amp;filter%5Btype_id%5D=&amp;page=2</span><br></pre></td></tr></table></figure>
<p>中间都是传递的筛选参数，只有最后 <code>&amp;page=2</code> 才是关键。也就是说抓取的页面URL是这样的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://www.jiandanxinli.com/experts?&amp;page=1</span><br><span class="line">https://www.jiandanxinli.com/experts?&amp;page=2</span><br><span class="line">...</span><br><span class="line">https://www.jiandanxinli.com/experts?&amp;page=49</span><br></pre></td></tr></table></figure>
<p>在 <code>class JdxlSpider(scrapy.Spider):</code> 下面开始定义起始 URL：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">allowed_domains = [<span class="string">"jiandanxinli.com"</span>]</span><br><span class="line">   start_urls = [<span class="string">'http://jiandanxinli.com/experts'</span>]</span><br><span class="line">   start_url_list = []</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">       start_url_list.extend([<span class="string">'http://jiandanxinli.com/experts?&amp;page='</span> + str(i)])</span><br><span class="line"></span><br><span class="line">   start_urls = start_url_list</span><br></pre></td></tr></table></figure>
<h3 id="问题2：如何抓取一个节点的信息"><a href="#问题2：如何抓取一个节点的信息" class="headerlink" title="问题2：如何抓取一个节点的信息"></a>问题2：如何抓取一个节点的信息</h3><p>在 <code>def parse(self, response):</code> 函数中定义要抓取内容，用 <a href="https://www.wikiwand.com/en/XPath" target="_blank" rel="noopener">XPath</a> 语法告诉爬虫要抓取的节点位置。</p>
<p>什么是「叉怕死」呢？</p>
<blockquote>
<p>XPath (XML Path Language) is a query language for selecting nodes from an XML document. In addition, XPath may be used to compute values (e.g., strings, numbers, or Boolean values) from the content of an XML document. —— Wiki</p>
</blockquote>
<p>那怎么写 XPath 呢？</p>
<p>感谢 Chrome，直接提供了 XPath 选取功能。对需要抓取的位置单击右键，点击 <code>Inspect</code>，打开 chrome-devtools 面板：</p>
<p><img src="http://img.viz.mobi/jdxlScrapy1.png" alt=""></p>
<p>对准要抓取的节点，再次右键，点击 <code>Copy XPath</code>，XPath 路径就复制好了。</p>
<p><img src="http://img.viz.mobi/jdxlScrapy2.png" alt=""></p>
<p>别高兴得太早，在调试坑里跌倒无数次的 00 颤抖地告诉你：<strong>直接复制的 XPath 往往不能直接用……</strong></p>
<p>比如上面的咨询师姓名这里，chrome 提供的路径是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//*[@id="content_wrapper"]/div[2]/div[2]/a[5]/div[1]/strong/text()</span><br></pre></td></tr></table></figure>
<p>但更准确的路径是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/div[@class="summary"]/strong/text()</span><br></pre></td></tr></table></figure>
<p>.</p>
<p>对初学者来说，如果之前没有太多写 html 和 css 的经验，每一个 xpath 都需要摸索好半天。不过这也是必经之路吧。折腾多了，就学会老老实实去看 <a href="https://www.w3schools.com/xml/xpath_intro.asp" target="_blank" rel="noopener">XPath 的文档</a>了。</p>
<h3 id="问题3：内容没有节点怎么办？"><a href="#问题3：内容没有节点怎么办？" class="headerlink" title="问题3：内容没有节点怎么办？"></a>问题3：内容没有节点怎么办？</h3><p>抓到咨询师的咨询方式、地点、价格等信息的时候，坑爹的事情来了。</p>
<p>这一坨的结构是：</p>
<p><img src="http://img.viz.mobi/jdxlScrapy3.png" alt=""></p>
<p>文字竟然没有包括在标签之内！前后都是个 i 标签！要怎么抓！</p>
<p>然后开始了漫漫 Google 之路。最后终于找到了这篇：<a href="https://www.zhihu.com/question/38080188" target="_blank" rel="noopener">如何用scrapy提取不在标签内的文字？</a></p>
<p>用 <code>following::text()</code> 的方式抓取了几个信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zx_type = response.xpath(<span class="string">'./div[@class="info"]/i/following::text()'</span>).extract()[<span class="number">1</span>]</span><br><span class="line">location = response.xpath(<span class="string">'./div[@class="info"]/i/following::text()'</span>).extract()[<span class="number">2</span>]</span><br><span class="line">price = response.xpath(<span class="string">'./div[@class="info"]/i/following::text()'</span>).extract()[<span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>这样必需是每一栏信息都没有缺少，否则抓取就会错位……暂时这么处理吧 &gt;.&lt;</p>
<h3 id="问题4：如何抓取多个专家信息"><a href="#问题4：如何抓取多个专家信息" class="headerlink" title="问题4：如何抓取多个专家信息"></a>问题4：如何抓取多个专家信息</h3><p>抓取好一个专家的信息后，要怎么把每个页面 10~11 个专家的信息都抓下来呢？看了页面的 html，每个专家都在 <code>&lt;a class=&quot;expert&quot; ...&gt;</code> 标签下面。于是用循环获取所有带有这个特征的标签。</p>
<p>为了缩小范围，在 <code>response.xpath(&#39;//a[@class=&quot;expert&quot;]&#39;)</code> 就传入了父节点的路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> response.xpath(<span class="string">'//a[@class="expert"]'</span>):</span><br><span class="line">    print(each)</span><br><span class="line">    item = JdxlItem()</span><br><span class="line">    <span class="comment"># 抓取姓名</span></span><br><span class="line">    item[<span class="string">'name'</span>] = each.xpath(<span class="string">'./div[@class="summary"]/strong/text()'</span>).extract()</span><br><span class="line">    <span class="comment"># 抓取 url</span></span><br><span class="line">    item[<span class="string">'url'</span>] = each.xpath(<span class="string">'./@href'</span>).extract()</span><br><span class="line">    <span class="comment"># 抓取简介</span></span><br><span class="line">    item[<span class="string">'info'</span>] = each.xpath(<span class="string">'./div[@class="summary"]//div[@class="content"]/text()'</span>).extract()</span><br><span class="line">    <span class="comment"># 抓取咨询方式、地点、价格等</span></span><br><span class="line">    item[<span class="string">'zx_type'</span>] = each.xpath(<span class="string">'./div[@class="info"]/i/following::text()'</span>).extract()[<span class="number">1</span>]</span><br><span class="line">    item[<span class="string">'location'</span>] = each.xpath(<span class="string">'./div[@class="info"]/i/following::text()'</span>).extract()[<span class="number">2</span>]</span><br><span class="line">    item[<span class="string">'price'</span>] = each.xpath(<span class="string">'./div[@class="info"]/i/following::text()'</span>).extract()[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>
<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><p>在 <code>settings.py</code> 文件里添加模拟 user_agent 的模块（需要先 pip 安装 faker 包）、设置爬取间隔、头信息等：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Factory</span><br><span class="line">f = Factory.create()</span><br><span class="line">USER_AGENT = f.user_agent()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Obey robots.txt rules</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">DOWNLOAD_DELAY = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">DEFAULT_REQUEST_HEADERS = &#123;</span><br><span class="line">    <span class="string">'Host'</span>: <span class="string">'www.jiandanxinli.com'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'*/*'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate, br'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Cache-Control'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'Keep-Alive'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试和抓取"><a href="#测试和抓取" class="headerlink" title="测试和抓取"></a>测试和抓取</h2><p>开始抓取的命令是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl counselor</span><br></pre></td></tr></table></figure>
<p>crawl 后面跟的是在 <code>class JdxlSpider(scrapy.Spider):</code> 中定义的爬虫名字。</p>
<p>先抓取 2 页试试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">3</span>):</span><br><span class="line">        start_url_list.extend([<span class="string">'http://jiandanxinli.com/experts?&amp;page='</span> + str(i)])</span><br></pre></td></tr></table></figure>
<p>调试过程主要问题是节点的 xpath 提供得不准确，没有抓取到内容。另外就是可能忘记在 <code>items.py</code> 里面设置 item。一般来说，根据报错慢慢找，总能找出问题，耐心一些就是了。</p>
<h2 id="输出-csv"><a href="#输出-csv" class="headerlink" title="输出 csv"></a>输出 csv</h2><p>查看了官方文档里面有关输出的部分 <a href="https://doc.scrapy.org/en/latest/topics/feed-exports.html" target="_blank" rel="noopener">Feed exports — Scrapy 1.4.0 documentation</a> 和 <a href="https://doc.scrapy.org/en/latest/topics/exporters.html" target="_blank" rel="noopener">Item Exporters — Scrapy 1.4.0 documentation</a>，试了一下写 pipelines，有点复杂，没有成功。</p>
<p>然后搜到 <a href="https://zhuanlan.zhihu.com/p/24769534" target="_blank" rel="noopener">Scrapy爬虫框架教程（二）– 爬取豆瓣电影TOP250</a>，只需要在执行爬虫时设置输出参数就可以了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl counselor -o output_file.csv</span><br></pre></td></tr></table></figure>
<h2 id="查看、清理数据"><a href="#查看、清理数据" class="headerlink" title="查看、清理数据"></a>查看、清理数据</h2><p>新建 Jupyter Notebook，import pandas 包，用 <code>pd.read_csv</code> 命令查看文件：</p>
<p><img src="http://img.viz.mobi/jdxlScrapyOutput.png" alt=""></p>
<p>抓取的链接不完整，补全并输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">'url'</span>] = <span class="string">'http://jiandanxinli.com'</span>+df[<span class="string">'url'</span>]</span><br><span class="line">df.to_csv(<span class="string">'counselor.csv'</span>, index=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<p>下一篇继续介绍用 Pandas 和 Bokeh 做简单的数据统计和可视化。</p>
<p>项目源码请查看 <a href="https://github.com/kidult00/scrapy-jdxl" target="_blank" rel="noopener">00 的 github repo</a>：</p>
<p><img src="http://img.viz.mobi/scrapy-jdxl-repo-qr.png" alt=""> </p>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><ul>
<li><a href="https://doc.scrapy.org/en/latest/" target="_blank" rel="noopener">Scrapy 1.5 documentation</a></li>
<li><a href="https://www.wikiwand.com/en/XPath" target="_blank" rel="noopener">XPath - Wikiwand</a></li>
<li><a href="https://www.w3schools.com/xml/xpath_intro.asp" target="_blank" rel="noopener">XPath Tutorial</a></li>
<li><a href="https://www.zhihu.com/question/38080188" target="_blank" rel="noopener">如何用scrapy提取不在标签内的文字？</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/24769534" target="_blank" rel="noopener">Scrapy爬虫框架教程（二）– 爬取豆瓣电影TOP250</a></li>
</ul>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/qrcode.jpg" alt="kidult00 wechat" style="width: 200px; max-width: 100%;"/>
    <div>扫码关注 00 的公众号</div>
</div>

      </div>
    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>如果文章帮您节省时间或者解答疑问，不妨打个赏 :)</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/paycode.png" alt="kidult00 微信支付"/>
        <p>微信支付</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/Coding/" rel="tag"># Coding</a>
          
            <a href="/tags/编程/" rel="tag"># 编程</a>
          
            <a href="/tags/爬虫/" rel="tag"># 爬虫</a>
          
            <a href="/tags/Scrapy/" rel="tag"># Scrapy</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/180108python-scrapy-introduction.html" rel="next" title="码以致用01 - Scrapy 爬虫框架简介">
                <i class="fa fa-chevron-left"></i> 码以致用01 - Scrapy 爬虫框架简介
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/180113-first-principle-of-learning.html" rel="prev" title="大哉问06 - 学习中最应该养成什么习惯？">
                大哉问06 - 学习中最应该养成什么习惯？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="kidult00" />
            
              <p class="site-author-name" itemprop="name">kidult00</p>
              <p class="site-description motion-element" itemprop="description">Designer / Maker / Learner</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">304</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">348</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="http://www.zhihu.com/people/kidult/" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/kidult00/" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/kidult00/" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:sysulj@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#目标和步骤"><span class="nav-number">1.</span> <span class="nav-text">目标和步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新建项目和爬虫"><span class="nav-number">2.</span> <span class="nav-text">新建项目和爬虫</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#抓取页面信息"><span class="nav-number">3.</span> <span class="nav-text">抓取页面信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#问题1：如何设置起始-URL？"><span class="nav-number">3.1.</span> <span class="nav-text">问题1：如何设置起始 URL？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题2：如何抓取一个节点的信息"><span class="nav-number">3.2.</span> <span class="nav-text">问题2：如何抓取一个节点的信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题3：内容没有节点怎么办？"><span class="nav-number">3.3.</span> <span class="nav-text">问题3：内容没有节点怎么办？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题4：如何抓取多个专家信息"><span class="nav-number">3.4.</span> <span class="nav-text">问题4：如何抓取多个专家信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他配置"><span class="nav-number">4.</span> <span class="nav-text">其他配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试和抓取"><span class="nav-number">5.</span> <span class="nav-text">测试和抓取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#输出-csv"><span class="nav-number">6.</span> <span class="nav-text">输出 csv</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查看、清理数据"><span class="nav-number">7.</span> <span class="nav-text">查看、清理数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ref"><span class="nav-number">7.1.</span> <span class="nav-text">Ref</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2007 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kidult00</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://uegeek.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://uegeek.com/180112python-scrapy-jdxl.html';
          this.page.identifier = '180112python-scrapy-jdxl.html';
          this.page.title = '码以致用02 - 用 Scrapy 爬虫抓取简单心理咨询师资料';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://uegeek.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
